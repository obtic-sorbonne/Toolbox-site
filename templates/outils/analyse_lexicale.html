{% extends "index.html" %}
{% block header %} {{ super() }} {% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename= 'css/elements.css') }}">
<div class="outil">
    <div class="fil"><a href="{{ url_for('analyses')}}"><< {{ _('Retour aux tâches') }}</a></div>
    <div>
        <h3>Analyse lexicale</h3>
        <p>Cette page permet d'opérer divers types d'analyses lexicales sur un ou plusieurs documents soumis.<br>
            <br>
        <ul class="item-list" style="margin-left: 3em;">
            <li><hi style="font-weight: bold;">Dispersion lexicale</hi> : Mesure montrant la distribution et l'occurrence de mots spécifiques dans un texte</li>
            <li><hi style="font-weight: bold;">Diversité lexicale</hi> : Mesure de la diversité du vocabulaire d'un texte en évaluant le nombre et la variété des mots utilisés</li>
            <li><hi style="font-weight: bold;">Relations lexicales</hi> : Mesure de la diversité du vocabulaire d'un texte en évaluant le nombre et la variété des mots utilisés</li>
            <li><hi style="font-weight: bold;">Spécificités lexicales</hi> : Score identifiant le caractère unique d'un mot ou d'une phrase dans un document par rapport à un corpus de texte plus vaste</li>
        </ul></p>
    </div>
    <br>
    <form action="{{ url_for('analyze_lexicale') }}" id="linguistic-form" method="post" enctype="multipart/form-data" onsubmit="return validateForm()">
        <div class="centered-div">
            <label for="analysis_type">Choisir le type d'analyse :</label>
            <select class="styled-select" name="analysis_type" id="analysis_type" required>
                <option value="lexical_dispersion">Dispersion lexicale</option>
                <option value="lexical_diversity">Diversité lexicale</option>
                <option value="lexical_relationships">Relations lexicales</option>
                <option value="lexical_specificity">Spécificités lexicales</option>
            </select>
        </div>
        {{ form.csrf_token }}
        <br>
        <div class="centered-input-div" id="words_to_analyze_container" style="display: none;">
            <label for="words_to_analyze_input">Mots à analyser (séparation : ";") :</label>
            <input type="text" id="words_to_analyze_input" name="words_to_analyze"><br>
        </div>
        
        <div class="centered-input-div" id="word_container" style="display: none;">
            <label for="word_input">Mot à analyser :</label>
            <input type="text" id="word_input" name="word"><br>
        </div>
        
        <div class="centered-input-div" id="words_list_container" style="display: none;">
            <label for="words_list_input">Mots à analyser (séparation : ";") :</label>
            <input type="text" id="words_list_input" name="words_list"><br>
        </div>
        <div class="dropzone" style="margin:25px auto;">
            <input type="file" id="files" name="files" accept="text/plain" multiple required>
            <p id="form_msg">Déposer le(s) fichier(s) ou cliquer ici.</p>
        </div>
        <input id="csrf_token" name="csrf_token" type="hidden" value="{{ csrf_token() }}">
        <button type="submit" style="display:block;margin:auto;margin-top:20px;">Lancer l'analyse</button>
    </form>
    {% if msg != "" %}
    <div><p>{{ msg }}</p></div>
    {% endif %}
    <div class="loader" id="loader" style="display: none;">
        <div class="loadingio-spinner-ball-205vl2x7n"><div class="ldio-b8p5li8dt1u"><div></div></div></div>
        <p>Traitement en cours...</p>
    </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("linguistic-form");
    const analysisTypeSelect = document.getElementById("analysis_type");
    
    // Initialize fields visibility
    toggleInputFields();
    
    // Add event listener for analysis type changes
    analysisTypeSelect.addEventListener("change", toggleInputFields);
    
    // File input handling
    const fileInput = document.getElementById("files");
    fileInput.addEventListener("change", updateFileDisplay);
});

function toggleInputFields() {
    const analysisType = document.getElementById("analysis_type").value;
    
    // Get all input containers
    const wordsToAnalyze = document.getElementById("words_to_analyze_container");
    const word = document.getElementById("word_container");
    const wordsList = document.getElementById("words_list_container");
    
    // Hide all containers and remove required attributes
    [wordsToAnalyze, word, wordsList].forEach(container => {
        if (container) {
            container.style.display = "none";
            const input = container.querySelector('input');
            if (input) {
                input.removeAttribute('required');
            }
        }
    });
    
    // Show only the needed container based on analysis type
    switch(analysisType) {
        case "lexical_dispersion":
            if (wordsToAnalyze) {
                wordsToAnalyze.style.display = "block";
                wordsToAnalyze.querySelector('input').setAttribute('required', 'required');
            }
            break;
        case "lexical_relationships":
            if (word) {
                word.style.display = "block";
                word.querySelector('input').setAttribute('required', 'required');
            }
            break;
        case "lexical_specificity":
            if (wordsList) {
                wordsList.style.display = "block";
                wordsList.querySelector('input').setAttribute('required', 'required');
            }
            break;
        case "lexical_diversity":
            // No input fields needed for diversity analysis
            break;
    }
}

function updateFileDisplay() {
    const fileInput = document.getElementById("files");
    const formMsg = document.getElementById("form_msg");
    const files = fileInput.files;
    
    if (files.length === 0) {
        formMsg.textContent = "Déposer le(s) fichier(s) ou cliquer ici.";
        return;
    }
    
    formMsg.textContent = `${files.length} fichier(s) selectionné(s)`;
    
    // Show preview of file names
    const maxPreview = 3;
    const previewFiles = Array.from(files).slice(0, maxPreview);
    
    previewFiles.forEach(file => {
        formMsg.innerHTML += `<br><span class="filename_preview">${file.name}</span>`;
    });
    
    if (files.length > maxPreview) {
        const remaining = files.length - maxPreview;
        formMsg.innerHTML += `<br><span class="filename_preview">et ${remaining} autres.</span>`;
    }
}

function validateForm() {
    const analysisType = document.getElementById("analysis_type").value;
    const files = document.getElementById("files").files;
    
    if (files.length === 0) {
        alert("Veuillez sélectionner au moins un fichier.");
        return false;
    }
    
    // Show loader
    document.getElementById("loader").style.display = "block";
    
    return true;
}
</script>
</div>
{% endblock %}
{% block footer %} {{ super() }} {% endblock %}